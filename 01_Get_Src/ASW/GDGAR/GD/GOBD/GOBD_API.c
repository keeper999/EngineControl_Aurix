/***************************** <AUTO_FILE_HEADER> *****************************/
/******************************************************************************/
/*                                                                            */
/* !Layer           : APPLI                                                   */
/*                                                                            */
/* !Component       : GOBD                                                    */
/* !Description     : GOBD Component                                          */
/*                                                                            */
/* !Module          : GOBD                                                    */
/* !Description     : Gestionnaire OBD                                        */
/*                                                                            */
/* !File            : GOBD_API.C                                              */
/*                                                                            */
/* !Scope           : Public                                                  */
/*                                                                            */
/* !Target          : 32BIT                                                   */
/*                                                                            */
/* !Vendor          : Valeo VEMS                                              */
/*                                                                            */
/* Coding language  : C                                                       */
/*                                                                            */
/* COPYRIGHT 2008 VALEO                                                       */
/* all rights reserved                                                        */
/*                                                                            */
/******************************************************************************/
/*   1 / GOBD_vidMngEveCDThdUp                                                */
/*   2 / GOBD_vidMngEveGlbDCStrt                                              */
/*   3 / GOBD_vidMngEveRstDftCal                                              */
/*   4 / GOBD_vidMngEveRstDft                                                 */
/*   5 / GOBD_vidMngEveRstDftObd                                              */
/*   6 / GOBD_vidMngEveDftUnval                                               */
/*   7 / GOBD_tenuGetStDgo                                                    */
/*   8 / GOBD_vidExitEveKeyOBD                                                */
/*   9 / GOBD_vidExitEveStObd                                                 */
/*   10 / GOBD_vidExitEveStObdRec                                             */
/*   11 / GOBD_vidExitEveStObdClear                                           */
/*                                                                            */
/* !Reference   : PTS_DOC_5075502 / 03                                        */
/*                                                                            */
/**************************** </AUTO_FILE_HEADER> *****************************/
/******************************************************************************/
/* PVCS Information                                                           */
/* $Archive::   P:/EB_DT/LOG/ASW/Ref/modules/GD/GOBD/GOBD_API.c_v            $*/
/* $Revision::   1.8      $$Author::   mbenfrad       $$Date::   11 Feb 2014 $*/
/* $Author::   mbenfrad                               $$Date::   11 Feb 2014 $*/
/******************************************************************************/
/* !VnrOff  : Names imposed by the customer                                   */
/******************************************************************************/
/* !CompReq :                                                                 */
/******************************************************************************/

#include "GOBD.h"
#include "GOBD_L.h"
#include "GOBD_macro.h"
#include "GOBD_im.h"
#include "GD_A.h"
#include "MATHSRV.h"

/*************************** <AUTO_FUNCTION_HEADER> ***************************/
/*                                                                            */
/* !Function    :  GOBD_vidMngEveCDThdUp                                      */
/* !Description :  API called on the event EveCDThdUp generated by the module */
/*                 GDU. This API calls after the GOBD functions linked to this*/
/*                 event.                                                     */
/* !Number      :  API.1                                                      */
/* !Author      :  A.BEN ZAYED                                                */
/*                                                                            */
/******************************************************************************/
/*                                                                            */
/*  extf argret void GOBD_vidCDThdUp(argin uint16 u16IdxDft);                 */
/*  extf argret void GOBD_vidAutomate(argin uint16 u16IdxDft);                */
/*  extf argret void GOBD_vidIniCntWUC(argin uint16 u16IdxDft);               */
/*  input uint8 GOBD_u8Inhib;                                                 */
/*                                                                            */
/************************** </AUTO_FUNCTION_HEADER> ***************************/
/************************* <AUTO_FUNCTION_PROTOTYPE> **************************/
void GOBD_vidMngEveCDThdUp
(
   uint16 u16IdxDft
)
{
   if(GOBD_u8Inhib != 0x5A)
   {
      GOBD_vidCDThdUp(u16IdxDft);
      GOBD_vidAutomate (u16IdxDft);
      GOBD_vidIniCntWUC (u16IdxDft);
   }
}/* mettre a jour GOBD_Macro.h si cette fonction evolue*/


/*************************** <AUTO_FUNCTION_HEADER> ***************************/
/*                                                                            */
/* !Function    :  GOBD_vidMngEveGlbDCStrt                                    */
/* !Description :  API called on the event EveGlbDcStrt generated by the      */
/*                 module DC. This API calls after the GOBD functions linked  */
/*                 to this event.                                             */
/* !Number      :  API.2                                                      */
/* !Author      :  A.BEN ZAYED                                                */
/*                                                                            */
/******************************************************************************/
/*                                                                            */
/*  extf argret void GOBD_vidWriteCntAcv(argin boolean bValue);               */
/*  extf argret void GOBD_vidCntWUC(argin uint16 u16IdxDft);                  */
/*  extf argret void GOBD_vidGlbDC(argin uint16 u16IdxDft);                   */
/*  extf argret void GOBD_vidAutomate(argin uint16 u16IdxDft);                */
/*  input uint8 GOBD_u8Inhib;                                                 */
/*                                                                            */
/************************** </AUTO_FUNCTION_HEADER> ***************************/
/************************* <AUTO_FUNCTION_PROTOTYPE> **************************/
void GOBD_vidMngEveGlbDCStrt(void)
{
   sint32 s32LocalIdxDft;
   sint32 s32LocalDivision;
   sint32 s32LocalMask;


   if (GOBD_u8Inhib != 0x5A)
   {
      GOBD_vidWriteCntAcv(TRUE);
      s32LocalIdxDft = 0;
      for ( s32LocalDivision = 0;
            s32LocalDivision < ((GD_DFT_NB + 7) / 8);
            s32LocalDivision++)
      {
         for ( s32LocalMask = 1;
               s32LocalMask < 256;
               s32LocalMask = s32LocalMask << 1)
         {
            GOBD_vidCntWUC_opt(s32LocalIdxDft);
            GOBD_vidGlbDC_opt(s32LocalIdxDft, s32LocalDivision, s32LocalMask);
            GOBD_vidAutomate_opt ((uint16)s32LocalIdxDft);
            if ( s32LocalIdxDft < (GD_DFT_NB - 1))
            {
               s32LocalIdxDft++;
            }
            else
            {
               s32LocalMask  = 256;
            }
         }
      }
   }
}


/*************************** <AUTO_FUNCTION_HEADER> ***************************/
/*                                                                            */
/* !Function    :  GOBD_vidMngEveRstDftCal                                    */
/* !Description :  API called on the event EveRstDftCal generated by the      */
/*                 module GDU . This API calls after the GOBD functions linked*/
/*                 to this event.                                             */
/* !Number      :  API.3                                                      */
/* !Author      :  A.BEN ZAYED                                                */
/*                                                                            */
/******************************************************************************/
/*                                                                            */
/*  extf argret void GOBD_vidRstCntDC(argin uint16 u16IdxDft);                */
/*  extf argret void GOBD_vidClrCntWUC(argin uint16 u16IdxDft);               */
/*  extf argret void GOBD_vidAutomateRstDft(argin uint16 u16IdxDft);          */
/*  input uint8 GOBD_u8Inhib;                                                 */
/*                                                                            */
/************************** </AUTO_FUNCTION_HEADER> ***************************/
/******************************************************************************/
/************************* <AUTO_FUNCTION_PROTOTYPE> **************************/
void GOBD_vidMngEveRstDftCal(void)
{
   sint32 s32LocalIdxDft;

   if(GOBD_u8Inhib != 0x5A)
   {
      for(s32LocalIdxDft = 0; s32LocalIdxDft < GD_DFT_NB; s32LocalIdxDft++)
      {
         GOBD_vidRstCntDC ((uint16)s32LocalIdxDft);
         GOBD_vidClrCntWUC ((uint16)s32LocalIdxDft);
         GOBD_vidAutomateRstDft ((uint16)s32LocalIdxDft);
      }
   }
}


/*************************** <AUTO_FUNCTION_HEADER> ***************************/
/*                                                                            */
/* !Function    :  GOBD_vidMngEveRstDft                                       */
/* !Description :  API called on the event EveRstDft generated by the module  */
/*                 GDGAR. This API calls after the GOBD functions linked to   */
/*                 this event.                                                */
/* !Number      :  API.4                                                      */
/* !Author      :  A.BEN ZAYED                                                */
/*                                                                            */
/******************************************************************************/
/*                                                                            */
/*  extf argret void GOBD_vidRstCntDC(argin uint16 u16IdxDft);                */
/*  extf argret void GOBD_vidClrCntWUC(argin uint16 u16IdxDft);               */
/*  extf argret void GOBD_vidAutomateRstDft(argin uint16 u16IdxDft);          */
/*  input uint8 GOBD_u8Inhib;                                                 */
/*                                                                            */
/************************** </AUTO_FUNCTION_HEADER> ***************************/
/************************* <AUTO_FUNCTION_PROTOTYPE> **************************/
void GOBD_vidMngEveRstDft(void)
{
   sint32 s32LocalIdxDft;

   if(GOBD_u8Inhib != 0x5A)
   {
      for(s32LocalIdxDft = 0; s32LocalIdxDft < GD_DFT_NB; s32LocalIdxDft++)
      {
         GOBD_vidRstCntDC((uint16)s32LocalIdxDft);
         GOBD_vidClrCntWUC ((uint16)s32LocalIdxDft);
         GOBD_vidAutomateRstDft ((uint16)s32LocalIdxDft);
      }
   }
}


/*************************** <AUTO_FUNCTION_HEADER> ***************************/
/*                                                                            */
/* !Function    :  GOBD_vidMngEveRstDftObd                                    */
/* !Description :  API called on the event EveRstDftObd generated by the      */
/*                 module GDGAR. This API calls after the GOBD functions      */
/*                 linked to this event.                                      */
/* !Number      :  API.5                                                      */
/* !Author      :  A.BEN ZAYED                                                */
/*                                                                            */
/******************************************************************************/
/*                                                                            */
/*  extf argret void GOBD_vidRstCntDC(argin uint16 u16IdxDft);                */
/*  extf argret void GOBD_vidClrCntWUC(argin uint16 u16IdxDft);               */
/*  extf argret void GOBD_vidAutomateRstDft(argin uint16 u16IdxDft);          */
/*  input uint8 GOBD_u8Inhib;                                                 */
/*  input GD_strClasObd GD_astrClasObd[40];                                   */
/*                                                                            */
/************************** </AUTO_FUNCTION_HEADER> ***************************/
/************************* <AUTO_FUNCTION_PROTOTYPE> **************************/
void GOBD_vidMngEveRstDftObd(void)
{
   sint32 s32LocalIdxDft;

   if(GOBD_u8Inhib != 0x5A)
   {
      for(s32LocalIdxDft = 0; s32LocalIdxDft < GD_DFT_NB; s32LocalIdxDft++)
      {
         if(GD_astrClasObd[GD_au8IdxClasObd[(uint16)s32LocalIdxDft]].bEnaSctl
             == TRUE)
         {
            GOBD_vidRstCntDC ((uint16)s32LocalIdxDft);
            GOBD_vidClrCntWUC ((uint16)s32LocalIdxDft);
            GOBD_vidAutomateRstDft ((uint16)s32LocalIdxDft);
         }
      }
   }
}


/*************************** <AUTO_FUNCTION_HEADER> ***************************/
/*                                                                            */
/* !Function    :  GOBD_vidMngEveDftUnval                                     */
/* !Description :  event produce by the GDU when the default enters in the    */
/*                 FUGITIF state.                                             */
/* !Number      :  API.6                                                      */
/* !Author      :  A.BEN ZAYED                                                */
/*                                                                            */
/******************************************************************************/
/*                                                                            */
/*  extf argret void GOBD_vidAutomateUnval(argin uint16 u16IdxDft);           */
/*  input uint8 GOBD_u8Inhib;                                                 */
/*                                                                            */
/************************** </AUTO_FUNCTION_HEADER> ***************************/
/************************* <AUTO_FUNCTION_PROTOTYPE> **************************/
void GOBD_vidMngEveDftUnval
(
   uint16 u16IdxDft
)
{
   if(GOBD_u8Inhib != 0x5A)
   {
      GOBD_vidAutomateUnval (u16IdxDft);
   }
}


/*************************** <AUTO_FUNCTION_HEADER> ***************************/
/*                                                                            */
/* !Function    :  GOBD_tenuGetStDgo                                          */
/* !Description :  API which returns the state of the GOBD manager.           */
/* !Number      :  API.7                                                      */
/* !Author      :  A.BEN ZAYED                                                */
/*                                                                            */
/******************************************************************************/
/*                                                                            */
/*  input GDFRM_tenuGOBDState GOBD_enustDgo[9];                               */
/*                                                                            */
/************************** </AUTO_FUNCTION_HEADER> ***************************/
/************************* <AUTO_FUNCTION_PROTOTYPE> **************************/
GDFRM_tenuGOBDState GOBD_tenuGetStDgo
(
   uint16 u16IdxDft
)
{
   return GOBD_enustDgo[u16IdxDft];
}

/*************************** <AUTO_FUNCTION_HEADER> ***************************/
/*                                                                            */
/* !Function    :  GOBD_vidExitEveKeyOBD                                      */
/* !Description :  function which manage the event KeyOBD produce by the      */
/*                 module and the scheduling of the call to the other module. */
/* !Number      :  API.8                                                      */
/* !Author      :  A.BEN ZAYED                                                */
/*                                                                            */
/******************************************************************************/
/*                                                                            */
/*  extf argret void GMIL_vidMngEveKeyOBD();                                  */
/*  extf argret void DC_vidMngEveKeyODB();                                    */
/*  input uint8 GOBD_u8Inhib;                                                 */
/*                                                                            */
/************************** </AUTO_FUNCTION_HEADER> ***************************/
/************************* <AUTO_FUNCTION_PROTOTYPE> **************************/
void GOBD_vidExitEveKeyOBD(void)
{
   if(GOBD_u8Inhib != 0x5A)
   {
      GMIL_vidMngEveKeyOBD();
      DC_vidMngEveKeyODB();
   }
}
/*************************** <AUTO_FUNCTION_HEADER> ***************************/
/*                                                                            */
/* !Function    :  GOBD_vidExitEveStObd                                       */
/* !Description :  Manage the scheduling on the event StDgo produce by GOBD.  */
/* !Number      :  API.9                                                      */
/* !Author      :  A.BEN ZAYED                                                */
/*                                                                            */
/******************************************************************************/
/*                                                                            */
/*  extf argret void StatusOfDtc_StGOBD(argin uint16 u16IdxDft);              */
/*  input uint8 GOBD_u8Inhib;                                                 */
/*                                                                            */
/************************** </AUTO_FUNCTION_HEADER> ***************************/
/************************* <AUTO_FUNCTION_PROTOTYPE> **************************/
void GOBD_vidExitEveStObd
(
   uint16 u16IdxDft
)
{
   if(GOBD_u8Inhib != 0x5A)
   {
      StatusOfDtc_StGOBD(u16IdxDft);
   }
}/* mettre a jour GOBD_Macro.h si cette fonction evolue*/
/*************************** <AUTO_FUNCTION_HEADER> ***************************/
/*                                                                            */
/* !Function    :  GOBD_vidExitEveStObdRec                                    */
/* !Description :  Evènement entrée du Gestionnaire OBD dans l'état           */
/*                 GOBD_ST_ENREGISTRE                                         */
/* !Number      :  API.10                                                     */
/* !Author      :  A.BEN ZAYED                                                */
/*                                                                            */
/******************************************************************************/
/*                                                                            */
/*  extf argret void MEM_vidMngEveStObdRec(argin uint16 u16IdxDft);           */
/*  extf argret void INDICOBD_vidMngEveStObdRec(argin uint16 u16IdxDft);      */
/*  extf argret void RC01_vidExitEveStObdRec(argin uint16 u16IdxDft);         */
/*  input uint8 GOBD_u8Inhib;                                                 */
/*                                                                            */
/************************** </AUTO_FUNCTION_HEADER> ***************************/
/************************* <AUTO_FUNCTION_PROTOTYPE> **************************/
void GOBD_vidExitEveStObdRec
(
   uint16 u16IdxDft
)
{
   if (GOBD_u8Inhib != 0x5A)
   {
      MEM_vidMngEveStObdRec(u16IdxDft);
      INDICOBD_vidMngEveStObdRec(u16IdxDft);
      RC01_vidExitEveStObdRec(u16IdxDft);    /*VEMS V02 ECU#065931*/
   }
}
/*************************** <AUTO_FUNCTION_HEADER> ***************************/
/*                                                                            */
/* !Function    :  GOBD_vidExitEveStObdClear                                  */
/* !Description :  Evènement de deconfirmation d'un défaut unitaire au sens   */
/*                 OBD                                                        */
/* !Number      :  API.11                                                     */
/* !Author      :  A.BEN ZAYED                                                */
/*                                                                            */
/******************************************************************************/
/*                                                                            */
/*  extf argret void INDICOBD_vidMngEveStObdClear(argin uint16 u16IdxDft);    */
/*  input uint8 GOBD_u8Inhib;                                                 */
/*                                                                            */
/************************** </AUTO_FUNCTION_HEADER> ***************************/
/******************************************************************************/
/************************* <AUTO_FUNCTION_PROTOTYPE> **************************/
void GOBD_vidExitEveStObdClear
(
   uint16 u16IdxDft
)
{
   if(GOBD_u8Inhib != 0x5A)
   {
      INDICOBD_vidMngEveStObdClear(u16IdxDft);
   }
}

/*------------------------------- end of file --------------------------------*/